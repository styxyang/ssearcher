#include "ss_config.h"
#include "ss_debug.h"
#include "ss_magic.h"
#include "ss_trie.h"

#define M_3GPP_FTYP        0x000001466747970
#define M_MP4_FTYP         0x000001866747970
#define M_3GPP2_FTYP       0x000002066747970
#define M_ICO              0x0000100
#define M_ZIP              0x04B0304
#define M_ZIP_EMPTY        0x04B0506
#define M_ZIP_SPANNED      0x04B0708
#define M_MS_OFFICE        0x0CF11E0
#define M_BMP              0x24D
#define M_RAR15            0x26172211A0700
#define M_RAR50            0x26172211A070100
#define M_ISO9660          0x344303031
#define M_PDF              0x5504446
#define M_FLAC             0x64C6143
#define M_GIF0             0x74946383761
#define M_GIF1             0x74946383961
#define M_PSD              0x8425053
#define M_MP3_V2           0x94433
#define M_TIF              0x9492A00
#define M_PNG              0x9504E470D0A1A0A
#define M_MACH_O_FAT_CLASS 0xAFEBABE
#define M_TIFF             0xD4D002A
#define M_EXE              0xD5A
#define M_MACH32_O_LE      0xEEDFACE
#define M_MACH64_O_LE      0xEEDFACF
#define M_MACH32_O_BE      0xEFAEDFE
#define M_ELF              0xF454C46
#define M_OGG              0xF676753
#define M_TAR_ZIP_LZW      0xF9D
#define M_TAR_ZIP_LZH      0xFA0
#define M_MACH64_O_BE      0xFFAEDFE
#define M_MP3_V01          0xFFB

static uint8_t magic_index[][MENTRY_LEN + 1] = {
    {0x00, 0x00, 0x01, 0x46, 0x67, 0x47, 0x97, 0x00, 7},
    {0x00, 0x00, 0x01, 0x86, 0x67, 0x47, 0x97, 0x00, 7},
    {0x00, 0x00, 0x02, 0x06, 0x67, 0x47, 0x97, 0x00, 7},
    {0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x04, 0xB0, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x04, 0xB0, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x04, 0xB0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x0C, 0xF1, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 1},
    {0x26, 0x17, 0x22, 0x11, 0xA0, 0x70, 0x00, 0x00, 6},
    {0x26, 0x17, 0x22, 0x11, 0xA0, 0x70, 0x10, 0x00, 7},
    {0x34, 0x43, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 4},
    {0x55, 0x04, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x64, 0xC6, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x74, 0x94, 0x63, 0x83, 0x76, 0x00, 0x00, 0x00, 5},
    {0x74, 0x94, 0x63, 0x83, 0x96, 0x00, 0x00, 0x00, 5},
    {0x84, 0x25, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x94, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 2},
    {0x94, 0x92, 0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0x95, 0x04, 0xE4, 0x70, 0xD0, 0xA1, 0xA0, 0x00, 7},
    {0xAF, 0xEB, 0xAB, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xD4, 0xD0, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xD5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 1},
    {0xEE, 0xDF, 0xAC, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xEE, 0xDF, 0xAC, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xEF, 0xAE, 0xDF, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xF4, 0x54, 0xC4, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xF6, 0x76, 0x75, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xF9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 1},
    {0xFA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 1},
    {0xFF, 0xAE, 0xDF, 0x00, 0x00, 0x00, 0x00, 0x00, 3},
    {0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 1}
};

#include <stdio.h>
#include <unistd.h>

static struct trie *tr;

void magic_init()
{
    int i;

    trie_init(&tr);
    for (i = 0; i < sizeof(magic_index) / (MENTRY_LEN + 1) / sizeof(uint8_t); ++i) {
        trie_insert(tr, &magic_index[i][0], magic_index[i][8]);
    }
}

void magic_fini()
{
    trie_destroy(tr);
}

/* bool magic_scan(uint8_t *buf, int len) */
bool magic_scan(int fd)
{
    uint8_t magic_buf[16];
    read(fd, magic_buf, sizeof(magic_buf));

    return trie_scan(tr, magic_buf, 16)?true:false;
}
